{% extends 'base.html' %}
{% load tz %}

{% block title %}ä¼è¨€æ¿ - Motitasu{% endblock %}

{% block extra_css %}
{% load static %}
<link rel="stylesheet" href="{% static 'bulletin_board/css/bulletin_board.css' %}">
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>ä¼è¨€æ¿</h2>
    
    <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ  -->
    {% if user.is_authenticated %}
    <div class="card mb-4">
        <div class="card-body">
            <form method="post">
                {% csrf_token %}
                <div class="mb-3">
                    <textarea class="form-control" name="content" rows="3" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..." maxlength="200" required></textarea>
                </div>
                <button type="submit" class="btn btn-primary">æŠ•ç¨¿</button>
            </form>
        </div>
    </div>
    {% endif %}
    
    <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸€è¦§ -->
    <div id="message-list">
        {% for message in page_obj %}
        <div class="card mb-3">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <strong>{{ message.user.name }}</strong>
                    {% timezone "Asia/Tokyo" %}
                    <small class="text-muted">{{ message.created_at|date:"Yå¹´mæœˆdæ—¥ H:i" }}</small>
                    {% endtimezone %}
                </div>
                
                <!-- ãƒ”ãƒ³ç•™ã‚è¡¨ç¤º -->
                {% if message.is_pinned %}
                <div class="mb-2">
                    <span class="badge bg-warning text-dark">ğŸ“Œ ãƒ”ãƒ³ç•™ã‚ä¸­</span>
                    {% if message.pin_expires_at %}
                    {% timezone "Asia/Tokyo" %}
                    <small class="text-muted">({{ message.pin_expires_at|date:"m/d H:i" }}ã¾ã§)</small>
                    {% endtimezone %}
                    {% endif %}
                </div>
                {% endif %}
                
                <p class="card-text">{{ message.content|linebreaks }}</p>
                
                <!-- ãƒ”ãƒ³ç•™ã‚ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ï¼ˆæŠ•ç¨¿è€…ã®ã¿è¡¨ç¤ºï¼‰ -->
                {% if message.user == user %}
                <div class="pin-controls mb-2" data-message-id="{{ message.id }}">
                    {% if message.is_pinned %}
                    <button class="btn btn-sm btn-outline-warning unpin-btn">ğŸ“Œ ãƒ”ãƒ³ç•™ã‚è§£é™¤</button>
                    {% else %}
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm btn-outline-secondary pin-btn" data-duration="12">12æ™‚é–“ãƒ”ãƒ³ç•™ã‚</button>
                        <button class="btn btn-sm btn-outline-secondary pin-btn" data-duration="24">24æ™‚é–“ãƒ”ãƒ³ç•™ã‚</button>
                        <button class="btn btn-sm btn-outline-secondary pin-btn" data-duration="168">1é€±é–“ãƒ”ãƒ³ç•™ã‚</button>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
                
                <!-- ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¨ãƒªã‚¢ -->
                <div class="reaction-area" data-message-id="{{ message.id }}">
                    {% for reaction_type, emoji in reaction_choices %}
                    <button class="reaction-btn btn btn-sm me-1 mb-1 {% if reaction_type in message.user_reactions %}btn-secondary{% else %}btn-outline-secondary{% endif %}" 
                            data-reaction-type="{{ reaction_type }}"
                            {% if not user.is_authenticated %}disabled{% endif %}>
                        {{ emoji }}
                        <span class="reaction-count">
                            {% for reaction in message.reaction_summary.items %}
                                {% if reaction.0 == reaction_type %}{{ reaction.1 }}{% endif %}
                            {% empty %}0{% endfor %}
                        </span>
                    </button>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% empty %}
        <div class="alert alert-info">
            ã¾ã ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã›ã‚“ã€‚
        </div>
        {% endfor %}
    </div>
    
    <!-- ãƒšãƒ¼ã‚¸ãƒ³ã‚° -->
    {% if page_obj.has_other_pages %}
    <nav aria-label="ãƒšãƒ¼ã‚¸ãƒ³ã‚°">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}">å‰ã¸</a>
            </li>
            {% endif %}
            
            {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                <li class="page-item active">
                    <span class="page-link">{{ num }}</span>
                </li>
                {% else %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                </li>
                {% endif %}
            {% endfor %}
            
            {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}">æ¬¡ã¸</a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>

<!-- ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="reactionUsersModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="reactionUsersList"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% load static %}
<script src="{% static 'bulletin_board/js/bulletin_board.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    document.querySelectorAll('.reaction-btn').forEach(button => {
        button.addEventListener('click', function() {
            const messageId = this.closest('.reaction-area').dataset.messageId;
            const reactionType = this.dataset.reactionType;
            
            fetch('{% url "bulletin_board:toggle_reaction" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': getCsrfToken()
                },
                body: `message_id=${messageId}&reaction_type=${reactionType}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ•°ã‚’æ›´æ–°
                    const countSpan = this.querySelector('.reaction-count');
                    countSpan.textContent = data.reaction_count;
                    
                    // ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ›´æ–°
                    if (data.action === 'added') {
                        this.classList.remove('btn-outline-secondary');
                        this.classList.add('btn-secondary');
                    } else {
                        this.classList.remove('btn-secondary');
                        this.classList.add('btn-outline-secondary');
                    }
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            });
        });
    });

    // ãƒ”ãƒ³ç•™ã‚ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    document.querySelectorAll('.pin-btn').forEach(button => {
        button.addEventListener('click', function() {
            const messageId = this.closest('.pin-controls').dataset.messageId;
            const duration = this.dataset.duration;
            
            fetch('{% url "bulletin_board:toggle_pin" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': getCsrfToken()
                },
                body: `message_id=${messageId}&action=pin&duration=${duration}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload(); // ãƒ”ãƒ³ç•™ã‚ã®è¡¨ç¤ºæ›´æ–°ã®ãŸã‚ãƒªãƒ­ãƒ¼ãƒ‰
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            });
        });
    });

    // ãƒ”ãƒ³ç•™ã‚è§£é™¤ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    document.querySelectorAll('.unpin-btn').forEach(button => {
        button.addEventListener('click', function() {
            const messageId = this.closest('.pin-controls').dataset.messageId;
            
            fetch('{% url "bulletin_board:toggle_pin" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': getCsrfToken()
                },
                body: `message_id=${messageId}&action=unpin`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload(); // ãƒ”ãƒ³ç•™ã‚ã®è¡¨ç¤ºæ›´æ–°ã®ãŸã‚ãƒªãƒ­ãƒ¼ãƒ‰
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            });
        });
    });

    // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ•°ã‚¯ãƒªãƒƒã‚¯ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§è¡¨ç¤º
    document.querySelectorAll('.reaction-count').forEach(countSpan => {
        countSpan.style.cursor = 'pointer';
        countSpan.addEventListener('click', function(e) {
            e.stopPropagation();
            const reactionBtn = this.closest('.reaction-btn');
            const messageId = reactionBtn.closest('.reaction-area').dataset.messageId;
            const reactionType = reactionBtn.dataset.reactionType;
            
            if (parseInt(this.textContent) > 0) {
                showReactionUsers(messageId, reactionType);
            }
        });
    });
});

function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

function showReactionUsers(messageId, reactionType) {
    fetch(`{% url "bulletin_board:get_reaction_users" 0 "dummy" %}`.replace('0', messageId).replace('dummy', reactionType))
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const usersList = document.getElementById('reactionUsersList');
            const modal = document.getElementById('reactionUsersModal');
            const modalTitle = modal.querySelector('.modal-title');
            
            modalTitle.textContent = `${data.emoji} ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼`;
            usersList.innerHTML = data.users.map(user => 
                `<div class="mb-2">
                    <strong>${user.name}</strong>
                    <small class="text-muted ms-2">${user.created_at}</small>
                </div>`
            ).join('');
            
            // Bootstrap Modal ã‚’è¡¨ç¤º
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
        } else {
            alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    });
}
</script>
{% endblock %}