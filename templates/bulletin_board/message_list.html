{% extends 'base.html' %}

{% block title %}伝言板{% endblock %}

{% block content %}
<h1>伝言板</h1>

<!-- メッセージ投稿フォーム -->
{% if user.is_authenticated %}
<form method="post">
    {% csrf_token %}
    <textarea name="content" rows="3" placeholder="メッセージを入力" maxlength="200" required></textarea><br>
    <button type="submit">投稿</button>
</form>
<hr>
{% endif %}

<!-- メッセージ一覧 -->
{% for message in page_obj %}
<div style="border: 1px solid #ccc; margin: 10px 0; padding: 10px;">
    <div>
        <strong>{{ message.user.name }}</strong>
        <span>{{ message.created_at|date:"Y-m-d H:i" }}</span>
    </div>
    
    <!-- ピン留め表示 -->
    {% if message.is_pinned %}
    <div>📌 ピン留め中 {% if message.pin_expires_at %}({{ message.pin_expires_at|date:"m/d H:i" }}まで){% endif %}</div>
    {% endif %}
    
    <p>{{ message.content|linebreaks }}</p>
    
    <!-- ピン留めコントロール -->
    {% if message.user == user %}
    <div class="pin-controls" data-message-id="{{ message.id }}">
        {% if message.is_pinned %}
        <button class="unpin-btn">ピン留め解除</button>
        {% else %}
        <button class="pin-btn" data-duration="12">12時間ピン留め</button>
        <button class="pin-btn" data-duration="24">24時間ピン留め</button>
        <button class="pin-btn" data-duration="168">1週間ピン留め</button>
        {% endif %}
    </div>
    {% endif %}
    
    <!-- リアクションエリア -->
    <div class="reaction-area" data-message-id="{{ message.id }}">
        {% for reaction_type, emoji in reaction_choices %}
        <button class="reaction-btn" data-reaction-type="{{ reaction_type }}" 
                {% if not user.is_authenticated %}disabled{% endif %}>
            {{ emoji }} 
            <span class="reaction-count">
                {% for reaction in message.reaction_summary.items %}
                    {% if reaction.0 == reaction_type %}{{ reaction.1 }}{% endif %}
                {% empty %}0{% endfor %}
            </span>
        </button>
        {% endfor %}
    </div>
</div>
{% empty %}
<p>メッセージがありません。</p>
{% endfor %}

<!-- ページング -->
{% if page_obj.has_other_pages %}
<div>
    {% if page_obj.has_previous %}
    <a href="?page={{ page_obj.previous_page_number }}">前へ</a>
    {% endif %}
    
    {% for num in page_obj.paginator.page_range %}
        {% if page_obj.number == num %}
        <strong>{{ num }}</strong>
        {% else %}
        <a href="?page={{ num }}">{{ num }}</a>
        {% endif %}
    {% endfor %}
    
    {% if page_obj.has_next %}
    <a href="?page={{ page_obj.next_page_number }}">次へ</a>
    {% endif %}
</div>
{% endif %}

<!-- Bootstrap リアクションユーザー一覧モーダル -->
<div class="modal fade" id="reactionUsersModal" tabindex="-1" aria-labelledby="reactionUsersModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reactionUsersModalLabel">リアクションしたユーザー<!-- タイトルは動的に変更されます --></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="閉じる"></button>
            </div>
            <div class="modal-body">
                <div id="reactionUsersList">
                    <!-- ユーザーリストがここに動的に挿入されます -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% load static %}
<script src="{% static 'bulletin_board/js/bulletin_board.js' %}"></script>
{% endblock %}