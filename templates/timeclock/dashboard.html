{% extends 'base.html' %}
{% load static %}

{% block title %}勤務ダッシュボード{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'timeclock/css/dashboard.css' %}?v={% now 'U' %}">
{% endblock %}

{% block content %}
<div class="container my-4">
    <h1 class="text-center mb-4">勤務ダッシュボード</h1>

    <!-- カレンダー -->
    <div class="summary-card calendar-card mb-4">
        <div class="card-header">
            <h5>カレンダー</h5>
        </div>
        <div class="card-body">
            <div class="calendar-nav-container">
                <div class="calendar-nav">
                {% if prev_month %}
                <a href="?year={{ prev_month.year }}&month={{ prev_month.month }}" class="nav-arrow">&#8249;</a>
                {% else %}
                <span class="nav-arrow disabled">&#8249;</span>
                {% endif %}

                <h3 class="calendar-title">{{ year }}年 {{ month }}月</h3>

                {% if next_month %}
                <a href="?year={{ next_month.year }}&month={{ next_month.month }}" class="nav-arrow">&#8250;</a>
                {% else %}
                <span class="nav-arrow disabled">&#8250;</span>
                {% endif %}
            </div>

                {% if next_month %}
                <a href="?year={% now 'Y' %}&month={% now 'n' %}" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-calendar-check"></i> 今月へ
                </a>
                {% endif %}
            </div>

            <table class="calendar-table">
            <thead>
                <tr>
                    {% for day in weekdays %}
                    <th class="{% if forloop.last %}sunday{% elif forloop.counter == 6 %}saturday{% endif %}">{{ day }}
                    </th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for week in calendar_weeks %}
                <tr>
                    {% for day_data in week %}
                    {% if day_data %}
                    <td
                        class="calendar-day {% if day_data.is_today %}today{% endif %} {% if day_data.has_data %}has-data{% endif %}">
                        <div class="day-number">{{ day_data.day }}</div>
                        {% if day_data.has_data %}
                        <div class="day-info">
                            <div class="work-hours">{{ day_data.work_hours }}h</div>
                            <div class="wage">{{ day_data.wage|floatformat:0 }}円</div>
                            {% if not day_data.has_clock_out %}
                            <div class="working-badge">勤務中</div>
                            {% endif %}
                        </div>
                        {% endif %}
                    </td>
                    {% else %}
                    <td class="calendar-day empty"></td>
                    {% endif %}
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
            </table>
        </div>
    </div>

    <!-- 月次サマリーカード -->
    <div class="row mb-3">
        <div class="col-lg-4 col-md-6 mb-3">
            <div class="summary-card monthly-wage">
                <div class="card-header">
                    <h5>今月の給与</h5>
                </div>
                <div class="card-body">
                    <div class="main-info animate-value">{{ monthly_summary.total_wage|floatformat:0|default:"0" }}円</div>
                    <div class="stats-row">
                        <span class="label">月勤務日数:</span>
                        <span class="value">{{ monthly_summary.work_days }}日</span>
                    </div>
                    <div class="stats-row">
                        <span class="label">月労働時間:</span>
                        <span class="value">{{ monthly_summary.total_work_hours }}時間</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4 col-md-6 mb-3">
            <div class="summary-card achievement">
                <div class="card-header">
                    <h5>目標達成率</h5>
                </div>
                <div class="card-body">
                    {% if monthly_summary.achievement_rate is not None %}
                    <div class="main-info animate-value {% if monthly_summary.achievement_rate >= 100 %}text-success{% endif %}">{{ monthly_summary.achievement_rate }}%</div>
                    <div class="progress-container">
                        <div class="progress-bar" data-achievement="{{ monthly_summary.achievement_rate }}">
                        </div>
                    </div>
                    <div class="stats-row">
                        <span class="label">月収目標:</span>
                        <span class="value">{{ monthly_summary.target_income|floatformat:0 }}円</span>
                    </div>
                    {% else %}
                    <div class="no-target">目標未設定</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-lg-4 col-md-12 mb-3">
            <div class="summary-card all-time">
                <div class="card-header">
                    <h5>累計統計</h5>
                </div>
                <div class="card-body">
                    <div class="stats-row">
                        <span class="label">総勤務日数:</span>
                        <span class="value animate-value">{{ all_time_stats.total_days }}日</span>
                    </div>
                    <div class="stats-row">
                        <span class="label">総労働時間:</span>
                        <span class="value animate-value">{{ all_time_stats.total_hours }}時間</span>
                    </div>
                    <div class="stats-row">
                        <span class="label">総給与:</span>
                        <span class="value animate-value">{{ all_time_stats.total_wage|floatformat:0 }}円</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 有給休暇情報 -->
    <div class="row mb-3">
        <div class="col-lg-6 col-md-6 mb-3">
            <div class="summary-card paid-leave">
                <div class="card-header">
                    <h5>有給休暇</h5>
                </div>
                <div class="card-body">
                    <!-- 付与条件達成状況 -->
                    <div class="mb-3">
                    {% if paid_leave_status.remaining_attendance_needed == 0 %}
                    <div class="main-info text-success">次回付与条件達成済み</div>
                    {% else %}
                    <div style="text-align: center;">{{ paid_leave_status.period_end }}までに</div>
                    <div class="main-info">あと <span class="animate-value">{{ paid_leave_status.remaining_attendance_needed|default:"--" }} 日</span>
                        <span class="text-info sub-info" data-bs-toggle="tooltip" data-bs-trigger="click"
                            data-bs-placement="bottom"
                            data-bs-title="{{ paid_leave_status.period_end }}までに{{ paid_leave_status.remaining_attendance_needed|default:'--' }}日出勤すると、有給休暇が{{ paid_leave_status.expected_grant_days }}日付与されます。">
                            <i class="bi bi-info-circle"></i>
                        </span>
                    </div>
                    <div style="text-align: center;">の出勤で有給が付与されます。</div>
                    {% endif %}
                    </div>
                    <div class="stats-row">
                        <div class="label">有給休暇残日数:</div>
                        <div class="value animate-value">
                            {{ paid_leave_status.total_balance|default:0 }} 日
                        </div>
                    </div>
                    <div class="stats-row">
                        <div class="label">失効間近:</div>
                        <div class="value">
                            {% if paid_leave_status.upcoming_expirations %}
                            {% for exp in paid_leave_status.upcoming_expirations %}
                            {{ exp.remaining_days }} 日（{{ exp.expiry_date|date:"n/j" }}に失効）{% if not forloop.last %}<br>{% endif %}
                            {% endfor %}
                            {% else %}
                            30日以内の失効なし
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6 col-md-6 mb-3">
            <div class="summary-card">
                <div class="card-header">
                    <h5>獲得バッチ</h5>
                </div>
                <div class="card-body">
                    {% if badges %}
                    <div class="badges-container">
                        {% for badge in badges %}
                        <div class="badge-item" data-bs-toggle="tooltip" data-bs-trigger="hover" data-bs-placement="top"
                            data-bs-title="{{ badge.description }}">
                            <img src="{{ badge.image_url }}" alt="{{ badge.name }}" class="badge-image">
                            <div class="badge-name">{{ badge.name }}</div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <div class="no-badges">まだ獲得したバッチはありません。</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-12 col-md-12 mb-3">
            <div class="summary-card">
                <div class="card-header">
                    <h5>スキルステップ</h5>
                </div>
                <div class="card-body">
                    {% if badges %}
                    <div class="badges-container">
                        {% for badge in badges %}
                        <div class="badge-item" data-bs-toggle="tooltip" data-bs-trigger="hover" data-bs-placement="top"
                            data-bs-title="{{ badge.description }}">
                            <img src="{{ badge.image_url }}" alt="{{ badge.name }}" class="badge-image">
                            <div class="badge-name">{{ badge.name }}</div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <div class="no-badges">まだ獲得したバッチはありません。</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

<!-- アクションボタン -->
    <div class="action-buttons">
        <a href="{% url 'timeclock' %}" class="btn btn-primary">打刻画面へ</a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'timeclock/js/dashboard.js' %}"></script>
{% endblock %}