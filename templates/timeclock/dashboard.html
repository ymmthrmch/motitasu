{% extends 'base.html' %}
{% load static %}

{% block title %}勤務ダッシュボード{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'timeclock/css/dashboard.css' %}?v={% now 'U' %}">
<link rel="stylesheet" href="{% static 'timeclock/css/skill-modal.css' %}?v={% now 'U' %}">
{% endblock %}

{% block content %}
<div class="container my-4">
    <h1 class="page-title"><i class="bi bi-bar-chart"></i> 勤務ダッシュボード</h1>

    <!-- 月選択ナビゲーション -->
        <div class="card-base mb-4">
            <div class="card-header-primary">
                <div class="d-flex justify-content-between align-items-center">
                    {% if prev_month %}
                    <a href="?year={{ prev_month.year }}&month={{ prev_month.month }}" class="btn btn-outline-light btn-sm">
                        <i class="bi bi-chevron-left"></i> {{ prev_month.month }}月
                    </a>
                    {% else %}
                    <div></div>
                    {% endif %}
                    
                    <h5 class="mb-0 me-3">{{ year }}年 {{ month }}月</h5>

                    {% if next_month and not is_current_month %}
                    <a href="?year={{ next_month.year }}&month={{ next_month.month }}" class="btn btn-outline-light btn-sm">
                        {{ next_month.month }}月 <i class="bi bi-chevron-right"></i>
                    </a>
                    {% else %}
                    <div></div>
                    {% endif %}
                </div>
            </div>
        </div>

    <!-- 月次サマリーカード -->
    <div class="row mb-3">
        <div class="col-lg-4 col-md-6 mb-3">
            <div class="summary-card monthly-wage">
                <div class="card-header">
                    <h5>今月の給与</h5>
                </div>
                <div class="card-body">
                    {% if user.current_hourly_wage %}
                        <div class="main-info animate-value">{{ monthly_summary.total_wage|floatformat:0|default:"0" }}円</div>
                    {% else %}
                        <div class="alert alert-warning text-center mb-3">
                            <i class="bi bi-exclamation-triangle fs-1 mb-3 d-block"></i>
                            <h6>給与グレード未設定</h6>
                            <p class="mb-0">管理者にお問い合わせください。</p>
                        </div>
                    {% endif %}
                    <div class="stats-row">
                        <span class="label">月勤務日数:</span>
                        <span class="value">{{ monthly_summary.work_days }}日</span>
                    </div>
                    <div class="stats-row">
                        <span class="label">月労働時間:</span>
                        <span class="value">{{ monthly_summary.total_work_hours }}時間</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4 col-md-6 mb-3">
            <div class="summary-card achievement">
                <div class="card-header">
                    <h5>目標達成率</h5>
                </div>
                <div class="card-body">
                    {% if monthly_summary.achievement_rate is not None %}
                    <div class="main-info animate-value {% if monthly_summary.achievement_rate >= 100 %}text-success{% endif %}">{{ monthly_summary.achievement_rate }}%</div>
                    <div class="progress-container">
                        <div class="progress-bar" data-achievement="{{ monthly_summary.achievement_rate }}">
                        </div>
                    </div>
                    <div class="stats-row">
                        <span class="label">月収目標:</span>
                        <span class="value">{{ monthly_summary.target_income|floatformat:0 }}円</span>
                    </div>
                    {% else %}
                    <div class="no-target">
                        <div class="text-center py-3 text-muted">
                            <i class="bi bi-target" style="font-size: 2rem;"></i>
                            <p class="mt-2 mb-0">目標未設定</p>
                            {% if is_current_month %}
                            <button type="button" class="btn-gradient-primary mt-3" id="setTargetBtn">
                                <i class="bi bi-plus"></i> 目標を設定
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-lg-4 col-md-12 mb-3">
            <div class="summary-card all-time">
                <div class="card-header">
                    <h5>累計統計</h5>
                </div>
                <div class="card-body">
                    <div class="stats-row">
                        <span class="label">総勤務日数:</span>
                        <span class="value animate-value">{{ all_time_stats.total_days }}日</span>
                    </div>
                    <div class="stats-row">
                        <span class="label">総労働時間:</span>
                        <span class="value animate-value">{{ all_time_stats.total_hours }}時間</span>
                    </div>
                    <div class="stats-row">
                        <span class="label">総給与:</span>
                        <span class="value animate-value">{{ all_time_stats.total_wage|floatformat:0 }}円</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 有給休暇情報 -->
    <div class="row mb-3">
        <div class="col-lg-6 col-md-6 mb-3">
            <div class="summary-card paid-leave">
                <div class="card-header">
                    <h5>有給休暇</h5>
                </div>
                <div class="card-body">
                    {% if paid_leave_status.hire_date_missing %}
                    <!-- 入社日未設定の場合 -->
                    <div class="alert alert-warning text-center mb-3">
                        <i class="bi bi-exclamation-triangle"></i>
                        <div class="mt-2">
                            <strong>入社日が未設定です</strong>
                        </div>
                        <div class="small mt-1">
                            有給休暇情報を表示するには入社日の設定が必要です
                        </div>
                    </div>
                    <div class="stats-row">
                        <div class="label">有給休暇残日数:</div>
                        <div class="value">--</div>
                    </div>
                    <div class="stats-row">
                        <div class="label">失効間近:</div>
                        <div class="value">--</div>
                    </div>
                    {% else %}
                    <!-- 付与条件達成状況 -->
                    <div class="mb-3">
                    {% if paid_leave_status.remaining_attendance_needed == 0 %}
                    <div class="main-info text-success">次回付与条件達成済み</div>
                    {% else %}
                    <div style="text-align: center;">{{ paid_leave_status.period_end }}までに</div>
                    <div class="main-info">あと <span class="animate-value">{{ paid_leave_status.remaining_attendance_needed|default:"--" }} 日</span>
                        <span class="text-info sub-info" data-bs-toggle="tooltip" data-bs-trigger="click"
                            data-bs-placement="bottom"
                            data-bs-title="{{ paid_leave_status.period_end }}までに{{ paid_leave_status.remaining_attendance_needed|default:'--' }}日出勤すると、有給休暇が{{ paid_leave_status.expected_grant_days }}日付与されます。">
                            <i class="bi bi-info-circle"></i>
                        </span>
                    </div>
                    <div style="text-align: center;">の出勤で有給が付与されます。</div>
                    {% endif %}
                    </div>
                    <div class="stats-row">
                        <div class="label">有給休暇残日数:</div>
                        <div class="value animate-value">
                            {{ paid_leave_status.total_balance|default:0 }} 日
                        </div>
                    </div>
                    <div class="stats-row">
                        <div class="label">失効間近:</div>
                        <div class="value">
                            {% if paid_leave_status.upcoming_expirations %}
                            {% for exp in paid_leave_status.upcoming_expirations %}
                            {{ exp.remaining_days }} 日（{{ exp.expiry_date|date:"n/j" }}に失効）{% if not forloop.last %}<br>{% endif %}
                            {% endfor %}
                            {% else %}
                            30日以内の失効なし
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-lg-6 col-md-6 mb-3">
            <div class="summary-card">
                <div class="card-header">
                    <h5>獲得バッチ</h5>
                </div>
                <div class="card-body">
                    {% if badges %}
                    <div class="badges-container">
                        {% for badge in badges %}
                        <div class="badge-item" data-bs-toggle="tooltip" data-bs-trigger="hover" data-bs-placement="top"
                            data-bs-title="{{ badge.description }}">
                            <img src="{{ badge.image_url }}" alt="{{ badge.name }}" class="badge-image">
                            <div class="badge-name">{{ badge.name }}</div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="no-badges">まだ獲得したバッチはありません。</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- 給与・スキル情報 -->
    {% if salary_skill_info %}
    <div class="row mb-3">
        <!-- 現在の給与グレード -->
        <div class="col-lg-6 col-md-6 mb-3">
            <div class="summary-card salary-grade">
                <div class="card-header">
                    <h5><i class="bi bi-star-fill"></i> 現在のグレード</h5>
                </div>
                <div class="card-body">
                    {% if salary_skill_info.has_salary_grade and salary_skill_info.current_grade_info %}
                    <div class="main-info animate-value text-primary">{{ salary_skill_info.current_grade_info.name }}</div>
                    <div class="stats-row">
                        <span class="label">レベル:</span>
                        <span class="value">{{ salary_skill_info.current_grade_info.level }}</span>
                    </div>
                    <div class="stats-row">
                        <span class="label">時給:</span>
                        <span class="value">{{ salary_skill_info.current_grade_info.hourly_wage }}円</span>
                    </div>
                    {% else %}
                    <div class="alert alert-warning text-center">
                        <i class="bi bi-exclamation-triangle fs-1 mb-3 d-block"></i>
                        <h6>給与グレード未設定</h6>
                        <p class="mb-0">管理者にお問い合わせください。</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- 習得済みスキル -->
        <div class="col-lg-6 col-md-6 mb-3">
            <div class="summary-card skills-summary">
                <div class="card-header">
                    <h5><i class="bi bi-patch-check-fill"></i> 習得スキル</h5>
                </div>
                <div class="card-body">
                    {% if salary_skill_info.acquired_skills %}
                    <div class="d-flex mb-2 flex-wrap gap-2">
                        {% for skill_info in salary_skill_info.acquired_skills %}
                        <div class="skill-badge skill-badge-acquired skill-badge-{{ skill_info.skill.category }} skill-detail-btn" 
                             data-skill-id="{{ skill_info.skill.id }}"
                             data-bs-toggle="tooltip" 
                             data-bs-placement="top"
                             data-bs-title="習得日: {{ skill_info.acquired_date }}">
                            <div class="skill-badge-icon">
                                <i class="bi bi-award-fill"></i>
                            </div>
                            <div class="skill-badge-content">
                                <div class="skill-badge-name">{{ skill_info.skill.name }}</div>
                                <div class="skill-badge-status">習得済み</div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-3 text-muted">
                        <i class="bi bi-info-circle mb-2 d-block fs-4"></i>
                        <small>まだ習得したスキルはありません</small>
                    </div>
                    {% endif %}
                    <div class="stats-row">
                        <span class="label">習得したスキル:</span>
                        <span class="value animate-value">{{ salary_skill_info.acquired_skills|length }}個</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if salary_skill_info.has_salary_grade and salary_skill_info.current_grade_info %}
    <!-- 昇進ルート -->
    <div class="summary-card mb-4">
        <div class="card-header">
            <h5><i class="bi bi-stair-up"></i>昇進ルート</h5>
        </div>
        <div class="card-body">
            <!-- 昇進ルート -->
            {% if salary_skill_info.promotion_paths %}
            <div class="mb-4">
                {% for path in salary_skill_info.promotion_paths %}
                <div class="promotion-route-area mb-3">
                    <div class="promotion-route-header">
                        <div class="d-flex align-items-center">
                            <h6 class="mb-0 text-primary">{{ path.grade.name }}</h6>
                        </div>
                        <div class="promotion-route-info">
                            <div class="info-item">
                                <span class="info-label">レベル:</span>
                                <span class="info-value">{{ path.grade.level }}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">時給:</span>
                                <span class="info-value">{{ path.grade.hourly_wage }}円</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">達成率:</span>
                                <span class="info-value animate-value">{{ path.completion_rate|floatformat:0 }}%</span>
                            </div>
                        </div>
                        <!-- プログレスバー -->
                        <div class="progress-container">
                            <div class="progress-bar" data-achievement="{{ path.completion_rate }}"></div>
                        </div>
                    </div>
                    
                    <div class="promotion-route-skills">
                        <div class="skills-label mb-2">
                            <i class="bi bi-list-check me-1"></i>
                            <small class="text-muted">必要スキル ({{ path.acquired_count }}/{{ path.required_count }})</small>
                        </div>
                        <div class="d-flex flex-wrap gap-2">
                            {% for skill_status in path.skill_status %}
                            <div class="skill-badge skill-badge-{{ skill_status.status }} skill-badge-{{ skill_status.skill.category }} skill-detail-btn"
                                 data-skill-id="{{ skill_status.skill.id }}"
                                 data-bs-toggle="tooltip" 
                                 data-bs-placement="top"
                                 data-bs-title="{% if skill_status.acquired %}習得済み{% elif skill_status.pending %}申告中{% else %}未習得{% endif %}">
                                <div class="skill-badge-icon skill-badge-icon-small">
                                    <i class="bi bi-{% if skill_status.acquired %}award-fill{% elif skill_status.pending %}hourglass-split{% else %}circle{% endif %}"></i>
                                </div>
                                <div class="skill-badge-content">
                                    <div class="skill-badge-name">{{ skill_status.skill.name }}</div>
                                    <div class="skill-badge-status">{% if skill_status.acquired %}習得済み{% elif skill_status.pending %}申告中{% else %}未習得{% endif %}</div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- 申告中スキル -->
            {% if salary_skill_info.skill_applications.pending %}
            <div class="pending-skills-area">
                <div class="d-flex align-items-center mb-3">
                    <h6 class="mb-0">申告中スキル</h6>
                    <span class="badge bg-warning ms-2">{{ salary_skill_info.skill_applications.pending|length }}</span>
                </div>
                <div class="d-flex flex-wrap gap-2">
                    {% for app in salary_skill_info.skill_applications.pending %}
                    <div class="skill-badge skill-badge-pending skill-badge-{{ app.skill.category }} skill-detail-btn"
                         data-skill-id="{{ app.skill.id }}"
                         data-bs-toggle="tooltip" 
                         data-bs-placement="top"
                         data-bs-title="申告日: {{ app.application_date|date:'n月d日' }}">
                        <div class="skill-badge-icon skill-badge-icon-small">
                            <i class="bi bi-hourglass-split"></i>
                        </div>
                        <div class="skill-badge-content">
                            <div class="skill-badge-name">{{ app.skill.name }}</div>
                            <div class="skill-badge-status">申告中</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
    {% endif %}

    <!-- カレンダー -->
    <div class="summary-card calendar-card mb-4">
        <div class="card-header">
            <h5>カレンダー</h5>
        </div>
        <div class="card-body">
            <h3 class="calendar-title">{{ year }}年 {{ month }}月</h3>

            <table class="calendar-table">
            <thead>
                <tr>
                    {% for day in weekdays %}
                    <th class="{% if forloop.last %}sunday{% elif forloop.counter == 6 %}saturday{% endif %}">{{ day }}
                    </th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for week in calendar_weeks %}
                <tr>
                    {% for day_data in week %}
                    {% if day_data %}
                    <td
                        class="calendar-day {% if day_data.is_today %}today{% endif %} {% if day_data.has_data %}has-data{% endif %}">
                        <div class="day-number">{{ day_data.day }}</div>
                        {% if day_data.has_data %}
                        <div class="day-info">
                            <div class="work-hours">{{ day_data.work_hours }}h</div>
                            <div class="wage">{{ day_data.wage|floatformat:0 }}円</div>
                            {% if not day_data.has_clock_out %}
                            <div class="working-badge">勤務中</div>
                            {% endif %}
                        </div>
                        {% endif %}
                    </td>
                    {% else %}
                    <td class="calendar-day empty"></td>
                    {% endif %}
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
            </table>
        </div>
    </div>
</div>

<!-- 月収目標設定モーダル -->
<div class="modal fade modal-common" id="setTargetModal" tabindex="-1" aria-labelledby="setTargetModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="setTargetModalLabel">
                    <i class="bi bi-target"></i> {{ year }}年{{ month }}月の目標月収設定
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="閉じる"></button>
            </div>
            <form id="setTargetForm">
                {% csrf_token %}
                <input type="hidden" name="year" value="{{ year }}">
                <input type="hidden" name="month" value="{{ month }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="targetIncome" class="form-label">目標月収（円）</label>
                        <input type="number" 
                               class="form-control" 
                               id="targetIncome" 
                               name="target_income" 
                               placeholder="例: 200000"
                               min="1"
                               max="9999999"
                               required>
                        <div class="form-text text-muted">
                            <i class="bi bi-info-circle"></i>
                            現在の時給: {% if user.current_hourly_wage %}{{ user.current_hourly_wage }}円{% else %}未設定{% endif %}
                        </div>
                    </div>
                    <div class="status-indicator status-info">
                        <i class="bi bi-lightbulb"></i>
                        目標を設定すると、ダッシュボードで達成率を確認できます。
                    </div>
                </div>
                <div class="modal-footer">
                    <div id="targetMessage" class="me-auto"></div>
                    <button type="submit" class="modal-submit-btn" id="setTargetSubmitBtn">
                        <i class="bi bi-check"></i> 設定する
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'common/js/utils.js' %}?v={% now 'U' %}"></script>
<script src="{% static 'timeclock/js/dashboard.js' %}?v={% now 'U' %}"></script>
<script src="{% static 'timeclock/js/salary_skill.js' %}?v={% now 'U' %}"></script>
{% endblock %}