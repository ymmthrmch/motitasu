{% extends 'base.html' %}
{% load static %}

{% block title %}打刻管理{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'timeclock/css/timeclock.css' %}?v={% now 'U' %}">
{% endblock %}

{% block content %}
<div class="container my-4">
    <h1 class="text-center mb-4">打刻管理システム</h1>

    <div class="clock-container mb-4">
        <div class="date-display" id="dateDisplay"></div>
        <div class="digital-clock" id="digitalClock">--:--:--</div>

        {% if last_record %}
        <div class="mt-3">
            {% if last_record.clock_type == 'clock_in' %}
            <span class="status-badge badge-working">勤務中</span>
            {% elif last_record.clock_type == 'break_start' %}
            <span class="status-badge badge-break">休憩中</span>
            {% elif last_record.clock_type == 'break_end' %}
            <span class="status-badge badge-working">勤務中</span>
            {% elif last_record.clock_type == 'clock_out' %}
            <span class="status-badge badge-finished">退勤済み</span>
            {% endif %}
        </div>
        {% endif %}
    </div>

    {% if messages %}
    <div class="mb-3">
        {% for message in messages %}
        {% if 'work_summary' not in message.tags %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endif %}
        {% endfor %}
    </div>
    {% endif %}

    {% if work_summary %}
    <div class="mb-3">
        <div class="work-summary-card fade show" role="alert">
            <div class="text-center mb-3">
                <h3 class="congratulations-title">
                    お疲れさまでした！
                </h3>
            </div>
            <div class="work-summary-content">
                <div class="summary-item work-time">
                    <span class="summary-label">
                        本日の労働時間
                    </span>
                    <span class="summary-value">{{ work_summary.work_time }}</span>
                </div>
                
                {% if work_summary.wage > 0 %}
                <div class="summary-item wage">
                    <span class="summary-label">
                        本日の給与
                    </span>
                    <span class="summary-value">{{ work_summary.wage|floatformat:0 }}円</span>
                </div>
                {% endif %}
                
                {% if work_summary.achievement_rate %}
                <div class="summary-item monthly-total">
                    <span class="summary-label">
                        今月の累計
                    </span>
                    <span class="summary-value">{{ work_summary.total_wage|floatformat:0 }}円 / {{ work_summary.target_income|floatformat:0 }}円</span>
                </div>
                
                <div class="summary-item achievement-rate">
                    <span class="summary-label">
                        目標月収達成率
                    </span>
                    <div class="achievement-container">
                        <span class="summary-value">{{ work_summary.achievement_rate }}%</span>
                        <div class="progress-container">
                            <div class="progress-bar" data-achievement="{{ work_summary.achievement_rate }}"></div>
                        </div>
                    </div>
                </div>

                <div class="summary-item dashboard-link-item">
                    <a href="{% url 'dashboard' %}" class="btn btn-primary view-dashboard-btn">
                        <i class="fas fa-chart-line"></i>
                        詳細なダッシュボードを見る
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    {% if available_actions %}
    <div class="clock-buttons mb-4">
        {% if 'clock_in' in available_actions %}
        <form method="post" action="{% url 'clock_action' %}">
            {% csrf_token %}
            <input type="hidden" name="action_type" value="clock_in">
            <button type="submit" class="clock-btn clock-in w-100">出勤</button>
        </form>
        {% endif %}

        {% if 'break_start' in available_actions %}
        <form method="post" action="{% url 'clock_action' %}">
            {% csrf_token %}
            <input type="hidden" name="action_type" value="break_start">
            <button type="submit" class="clock-btn break-start w-100">休憩開始</button>
        </form>
        {% endif %}

        {% if 'break_end' in available_actions %}
        <form method="post" action="{% url 'clock_action' %}">
            {% csrf_token %}
            <input type="hidden" name="action_type" value="break_end">
            <button type="submit" class="clock-btn break-end w-100">休憩終了</button>
        </form>
        {% endif %}

        {% if 'clock_out' in available_actions %}
        <form method="post" action="{% url 'clock_action' %}">
            {% csrf_token %}
            <input type="hidden" name="action_type" value="clock_out">
            <button type="submit" class="clock-btn clock-out w-100">退勤</button>
        </form>
        {% endif %}
    </div>
    {% endif %}

    {% if today_records %}
    <div class="records-container">
        <h3 class="mb-3">本日の打刻記録</h3>
        {% for record in today_records %}
        <div class="record-item record-{{ record.clock_type }}">
            <div>
                <strong>{{ record.get_clock_type_display }}</strong>
            </div>
            <div>
                {{ record.timestamp|date:"H:i:s" }}
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

<input type="hidden" id="currentTimeUrl" value="{% url 'get_current_time' %}">
{% endblock %}

{% block extra_js %}
<script src="{% static 'timeclock/js/timeclock.js' %}"></script>
{% endblock %}