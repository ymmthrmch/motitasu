{% extends 'base.html' %}
{% load static %}

{% block title %}打刻管理{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'timeclock/css/timeclock.css' %}?v={% now 'U' %}">
<link rel="stylesheet" href="{% static 'bulletin_board/css/bulletin_board.css' %}?v={% now 'U' %}">
{% endblock %}

{% block content %}
<div class="container my-4">
    <h1 class="page-title"><i class="bi bi-clock"></i> 打刻管理システム</h1>

    <div class="clock-container mb-4">
        <div class="date-display" id="dateDisplay"></div>
        <div class="digital-clock" id="digitalClock">--:--:--</div>

        {% if last_record %}
        <div class="mt-3">
            {% if last_record.clock_type == 'clock_in' %}
            <span class="status-indicator status-success">
                勤務中
            </span>
            {% elif last_record.clock_type == 'break_start' %}
            <span class="status-indicator status-info">
                休憩中
            </span>
            {% elif last_record.clock_type == 'break_end' %}
            <span class="status-indicator status-success">
                勤務中
            </span>
            {% elif last_record.clock_type == 'clock_out' %}
            <span class="status-indicator status-danger">
                退勤済み
            </span>
            {% endif %}
        </div>
        {% endif %}
    </div>

    {% if messages %}
    <div class="mb-3">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {% if work_summary %}
    <div class="mb-3">
        <div class="work-summary-card fade show" role="alert">
            <div class="text-center mb-3">
                <h3 class="congratulations-title">
                    お疲れさまでした！
                </h3>
            </div>
            <div class="work-summary-content">
                <div class="summary-item work-time">
                    <span class="summary-label">
                        本日の労働時間
                    </span>
                    <span class="summary-value">{{ work_summary.work_time }}</span>
                </div>
                
                {% if work_summary.wage > 0 %}
                <div class="summary-item wage">
                    <span class="summary-label">
                        本日の給与
                    </span>
                    <span class="summary-value">{{ work_summary.wage|floatformat:0 }}円</span>
                </div>
                {% endif %}
                
                {% if work_summary.achievement_rate %}
                <div class="summary-item monthly-total">
                    <span class="summary-label">
                        今月の累計
                    </span>
                    <span class="summary-value">{{ work_summary.total_wage|floatformat:0 }}円 / {{ work_summary.target_income|floatformat:0 }}円</span>
                </div>
                
                <div class="summary-item achievement-rate">
                    <span class="summary-label">
                        目標月収達成率
                    </span>
                    <div class="achievement-container">
                        <span class="summary-value">{{ work_summary.achievement_rate }}%</span>
                        <div class="progress-container">
                            <div class="progress-bar" data-achievement="{{ work_summary.achievement_rate }}"></div>
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if work_summary.leaderboard %}
                <div class="summary-item leaderboard-rank">
                    <span class="summary-label">
                        現在の順位
                    </span>
                    <span class="summary-value">{{ work_summary.leaderboard.rank }}位 / {{ work_summary.leaderboard.all_entries }}人</span>
                </div>
                {% endif %}

                <div class="summary-item dashboard-link-item">
                    <a href="{% url 'timeclock:dashboard' %}" class="btn btn-primary view-dashboard-btn">
                        <i class="fas fa-chart-line"></i>
                        詳細なダッシュボードを見る
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 投稿提案カード -->
    <div class="mb-3">
        <div class="card-base">
            <div class="card-header-success">
                <h5><i class="bi bi-pencil-square"></i> 今日のエピソードを共有</h5>
            </div>
            <div class="card-body-standard text-center">
                <p class="mb-3">
                    業務連絡やお客様からの感謝の言葉、仲間のファインプレーを共有しましょう！
                </p>
                <button type="button" class="btn-gradient-success" id="showPostModalFromTimeclock">
                    <i class="bi bi-pencil-square"></i>
                    伝言を投稿
                </button>
            </div>
        </div>
    </div>
    {% endif %}

    {% if available_actions %}
    <div class="clock-buttons mb-4">
        {% if 'clock_in' in available_actions %}
        <form method="post" action="{% url 'timeclock:clock_action' %}">
            {% csrf_token %}
            <input type="hidden" name="action_type" value="clock_in">
            <button type="submit" class="clock-btn clock-in w-100">出勤</button>
        </form>
        {% endif %}

        {% if 'break_start' in available_actions %}
        <form method="post" action="{% url 'timeclock:clock_action' %}">
            {% csrf_token %}
            <input type="hidden" name="action_type" value="break_start">
            <button type="submit" class="clock-btn break-start w-100">休憩開始</button>
        </form>
        {% endif %}

        {% if 'break_end' in available_actions %}
        <form method="post" action="{% url 'timeclock:clock_action' %}">
            {% csrf_token %}
            <input type="hidden" name="action_type" value="break_end">
            <button type="submit" class="clock-btn break-end w-100">休憩終了</button>
        </form>
        {% endif %}

        {% if 'clock_out' in available_actions %}
        <form method="post" action="{% url 'timeclock:clock_action' %}">
            {% csrf_token %}
            <input type="hidden" name="action_type" value="clock_out">
            <button type="submit" class="clock-btn clock-out w-100">退勤</button>
        </form>
        {% endif %}
    </div>
    {% endif %}

    {% if today_records %}
    <div class="records-container">
        <h3 class="mb-3">本日の打刻記録</h3>
        {% for record in today_records %}
        <div class="record-item record-{{ record.clock_type }}">
            <div>
                <strong>{{ record.get_clock_type_display }}</strong>
            </div>
            <div>
                {{ record.timestamp|date:"H:i:s" }}
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

<!-- 投稿モーダル -->
{% if user.is_authenticated %}
<div class="modal fade post-modal" id="postModal" tabindex="-1" aria-labelledby="postModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="postModalLabel"><i class="bi bi-pencil-square"></i> 新しいメッセージ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="閉じる"></button>
            </div>
            <form method="post" action="{% url 'bulletin_board:message_list' %}" id="modalMessageForm">
                {% csrf_token %}
                <div class="modal-body">
                    <textarea 
                        name="content" 
                        class="modal-textarea" 
                        placeholder="メッセージを入力してください..." 
                        maxlength="200" 
                        required
                        id="modalTextarea"></textarea>
                    
                    <div class="form-check mt-3">
                        <input class="form-check-input" type="checkbox" name="show_name" id="showNameCheck">
                        <label class="form-check-label small text-muted" for="showNameCheck">
                            名前を表示する
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="draft-indicator" id="draftIndicator" style="display: none;">
                        <span>下書きが復元されました</span>
                    </div>
                    <div class="modal-char-counter" id="modalCharCounter">0/200文字</div>
                    <button type="submit" class="modal-submit-btn" id="modalSubmitBtn">
                        <i class="bi bi-pencil-square"></i> 投稿する
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<input type="hidden" id="currentTimeUrl" value="{% url 'timeclock:get_current_time' %}">
{% endblock %}

{% block extra_js %}
<script src="{% static 'timeclock/js/timeclock.js' %}?v={% now 'U' %}"></script>
<script src="{% static 'bulletin_board/js/bulletin_board.js' %}?v={% now 'U' %}"></script>
{% endblock %}