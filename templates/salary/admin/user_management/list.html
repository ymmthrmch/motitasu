{% extends "base.html" %}
{% load static %}

{% block title %}ユーザー管理 - Motitasu{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'salary/css/admin.css' %}">
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- パンくずリスト -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{% url 'salary:admin_dashboard' %}">
                    <i class="bi bi-speedometer2"></i> 管理ダッシュボード
                </a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">
                <i class="bi bi-people"></i> ユーザー管理
            </li>
        </ol>
    </nav>

    <!-- ヘッダー -->
    <div class="text-center mb-4">
        <h2 class="page-title">
            <i class="bi bi-people"></i>ユーザー管理
        </h2>
        <div class="mt-2">
            <span class="status-indicator status-info">
                {{ users|length }}人のユーザー
            </span>
        </div>
    </div>

    <!-- 検索・フィルタエリア -->
    <div class="card-base mb-4">
        <div class="card-header-primary">
            <h5 class="mb-0">
                <i class="bi bi-search"></i> ユーザー検索・フィルタ
            </h5>
        </div>
        <div class="card-body-standard">
            <form method="get" id="searchForm">
                <div class="row">
                    <div class="col-md-4">
                        <label for="search" class="form-label">名前・メール検索</label>
                        <input type="text" class="form-control" id="search" name="search" 
                               value="{{ request.GET.search }}" placeholder="ユーザー名またはメールアドレス">
                    </div>
                    <div class="col-md-3">
                        <label for="grade" class="form-label">グレードフィルタ</label>
                        <select class="form-select" id="grade" name="grade">
                            <option value="">すべてのグレード</option>
                            {% for grade in salary_grades %}
                                <option value="{{ grade.id }}" {% if request.GET.grade == grade.id|stringformat:"s" %}selected{% endif %}>
                                    {{ grade.name }}
                                </option>
                            {% endfor %}
                            <option value="none" {% if request.GET.grade == "none" %}selected{% endif %}>グレード未設定</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="skill" class="form-label">スキルフィルタ</label>
                        <select class="form-select" id="skill" name="skill">
                            <option value="">すべてのスキル</option>
                            {% for skill in skills %}
                                <option value="{{ skill.id }}" {% if request.GET.skill == skill.id|stringformat:"s" %}selected{% endif %}>
                                    {{ skill.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-grid">
                            <button type="submit" class="btn-gradient-primary">
                                <i class="bi bi-search"></i> 検索
                            </button>
                        </div>
                    </div>
                </div>
                {% if request.GET.search or request.GET.grade or request.GET.skill %}
                    <div class="mt-3 text-end">
                        <a href="{% url 'salary:admin_user_management' %}" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-x"></i> フィルタクリア
                        </a>
                    </div>
                {% endif %}
            </form>
        </div>
    </div>

    {% if users %}
    <!-- ユーザー一覧 -->
    <div class="card-base">
        <div class="p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th width="25%">ユーザー</th>
                            <th width="15%">現在のグレード</th>
                            <th width="15%">昇進条件</th>
                            <th width="15%">最終ログイン</th>
                            <th width="10%">管理</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr class="user-row" data-user-id="{{ user.id }}">
                            <td>
                                <div class="d-flex align-items-center">
                                    <span class="user-avatar me-3">
                                        {{ user.name|first }}
                                    </span>
                                    <div>
                                        <div class="fw-semibold">{{ user.name }}</div>
                                        <small class="text-muted">{{ user.email }}</small>
                                        {% if user.is_staff %}
                                            <span class="status-indicator status-warning btn-sm ms-2">管理者</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td>
                                {% if user.current_salary_grade %}
                                    <span class="status-indicator status-success">
                                        {{ user.current_salary_grade.name }}
                                    </span>
                                {% else %}
                                    <span class="status-indicator status-warning">
                                        未設定
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                {% if user.promotion_conditions %}
                                    <div class="promotion-conditions">
                                        {% for condition in user.promotion_conditions %}
                                            <div class="promotion-item mb-1">
                                                {% if condition.can_promote %}
                                                    <span class="status-indicator status-success me-1">
                                                        <i class="bi bi-check-circle"></i> {{ condition.grade.name }}
                                                    </span>
                                                {% else %}
                                                    <span class="status-indicator status-danger me-1">
                                                        <i class="bi bi-x-circle"></i> {{ condition.grade.name }}
                                                    </span>
                                                {% endif %}
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <span class="text-muted">
                                        {% if user.current_salary_grade %}最上位{% else %}グレード未設定{% endif %}
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                {% if user.last_login %}
                                    <div>{{ user.last_login|date:"Y/m/d H:i" }}</div>
                                {% else %}
                                    <span class="text-muted">未ログイン</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{% url 'salary:admin_user_detail' user.id %}" 
                                   class="btn-gradient-primary btn-sm">
                                    <i class="bi bi-person-gear"></i> 管理
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ページネーション（必要に応じて後で追加）-->
    
    {% else %}
    <!-- 空状態または検索結果なし -->
    <div class="card-base">
        <div class="card-body-standard text-center py-5">
            {% if request.GET.search or request.GET.grade or request.GET.skill %}
                <i class="bi bi-search text-muted" style="font-size: 4rem;"></i>
                <h4 class="mt-3 mb-2">検索結果が見つかりません</h4>
                <p class="text-muted mb-4">検索条件を変更して再度お試しください。</p>
                <a href="{% url 'salary:admin_user_management' %}" class="btn-gradient-primary">
                    <i class="bi bi-arrow-clockwise"></i> 全ユーザーを表示
                </a>
            {% else %}
                <i class="bi bi-people text-muted" style="font-size: 4rem;"></i>
                <h4 class="mt-3 mb-2">ユーザーが見つかりません</h4>
                <p class="text-muted">システムにユーザーが登録されていません。</p>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ユーザー行クリックで詳細画面への遷移
    const userRows = document.querySelectorAll('.user-row');
    userRows.forEach(row => {
        row.style.cursor = 'pointer';
        row.addEventListener('click', function(e) {
            // ボタンクリックの場合は無視
            if (e.target.closest('a, button')) return;
            
            const userId = this.dataset.userId;
            window.location.href = `/salary/admin/user-management/${userId}/`;
        });
    });

    // 行のホバーエフェクト
    userRows.forEach(row => {
        row.addEventListener('mouseenter', function() {
            this.style.backgroundColor = 'rgba(0, 123, 255, 0.08)';
        });
        row.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '';
        });
    });
});
</script>
{% endblock %}