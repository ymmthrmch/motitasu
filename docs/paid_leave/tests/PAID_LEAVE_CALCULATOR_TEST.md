# PaidLeaveCalculatorクラステスト仕様書

## 概要
本仕様書は、PaidLeaveCalculatorクラスの各メソッドに対するテストケースを定義する。
各テストケースでは、設定値と期待される検証結果を明確に定義し、有給休暇付与ルールに従った正確な計算処理が行われることを検証する。

## テストケース一覧

### 1. 付与日計算メソッド（calculate_grant_date）のテスト

#### テストケース1-1: 通常日付での付与日計算
**目的**: 通常の日付（月末でない日）での付与日計算の正確性を検証
**設定値**:
- 入社日: 2000年1月1日
- テスト対象付与回数: 1回目、2回目、3回目、7回目

**検証値と期待結果**:
- 1回目付与日: 2000年7月1日（入社日の6か月後）
- 2回目付与日: 2001年7月1日（1回目の1年後）
- 3回目付与日: 2002年7月1日（1回目の2年後）
- 7回目付与日: 2006年7月1日（1回目の6年後）

#### テストケース1-2: 月末入社での付与日計算（閏年考慮）
**目的**: 月末入社時の付与日計算と閏年対応の検証
**設定値**:
- 入社日: 2003年8月31日
- テスト対象付与回数: 1回目、2回目、3回目、4回目、5回目

**検証値と期待結果**:
- 1回目付与日: 2004年2月29日（8月31日の6か月後、2月31日→29日調整）
- 2回目付与日: 2005年2月28日（2004年2月29日の1年後、閏年でないため）
- 3回目付与日: 2006年2月28日（2004年2月29日の2年後）
- 4回目付与日: 2007年2月28日（2004年2月29日の3年後）
- 5回目付与日: 2008年2月29日（2004年2月29日の4年後、閏年）

#### テストケース1-3: 月末調整が必要な日付での付与日計算
**目的**: 存在しない日付の月末調整処理の検証
**設定値**:
- 入社日: 2000年8月29日
- テスト対象付与回数: 1回目、2回目、3回目

**検証値と期待結果**:
- 1回目付与日: 2001年2月28日（2月29日が存在しないため月末調整）
- 2回目付与日: 2002年2月28日
- 3回目付与日: 2003年2月28日
- 4回目付与日: 2004年2月29日

### 2. 判定対象期間計算メソッド（calculate_judgment_period）のテスト

#### テストケース2-1: 初回付与の判定期間
**目的**: 初回付与時の判定期間が正しく計算されることを検証
**設定値**:
- 入社日: 2000年4月1日
- 付与回数: 1回目

**検証値と期待結果**:
- 期間開始日: 2000年4月1日（入社日）
- 期間終了日: 2000年9月30日（初回付与日前日）

#### テストケース2-2: 2回目以降の判定期間
**目的**: 2回目以降の判定期間が前回付与日を基準に計算されることを検証
**設定値**:
- 入社日: 2000年4月1日
- 付与回数: 2回目、3回目

**検証値と期待結果**:
- 2回目の期間開始日: 2000年10月1日（1回目付与日）
- 2回目の期間終了日: 2001年9月30日（2回目付与日前日）
- 3回目の期間開始日: 2001年10月1日（2回目付与日）
- 3回目の期間終了日: 2002年9月30日（3回目付与日前日）

### 3. 次回付与情報取得メソッド（get_next_grant_info）のテスト

#### テストケース3-1: 初回付与前の情報取得
**目的**: 入社後、初回付与前の時点での次回付与情報が正しく取得できることを検証
**設定値**:
- 入社日: 2024年1月1日
- 基準日: 2024年4月1日
- 週所定労働日数: 5日
- 現在までの出勤日数: 60日

**検証値と期待結果**:
- next_grant_date: 2024年7月1日
- days_until_grant: 91日
- current_attendance_days: 60日
- required_attendance_days: 104日（130日間の80%）
- remaining_attendance_needed: 44日
- expected_grant_days: 10日
- current_attendance_rate: 0.9230...（92.3%）

#### テストケース3-2: 2回目付与前の情報取得
**目的**: 1回目付与後、2回目付与前の時点での次回付与情報が正しく取得できることを検証
**設定値**:
- 入社日: 2023年1月1日
- 基準日: 2024年4月1日
- 週所定労働日数: 4日
- 1回目付与日からの出勤日数: 125日

**検証値と期待結果**:
- next_grant_date: 2024年7月1日
- days_until_grant: 91日
- current_attendance_days: 125日
- required_attendance_days: 168日
- remaining_attendance_needed: 43日
- expected_grant_days: 8日
- current_attendance_rate: 0.7961...（79.61%%）

### 4. 所定労働日数計算メソッド（calculate_required_work_days）のテスト

#### テストケース4-1: 週5日勤務の所定労働日数計算
**目的**: 通常労働者の所定労働日数が正しく計算されることを検証
**設定値**:
- 期間開始日: 2024年1月1日
- 期間終了日: 2024年6月30日
- 週所定労働日数: 5日

**検証値と期待結果**:
- 期間日数: 182日
- 所定労働日数: 130日

#### テストケース4-2: 週3日勤務の所定労働日数計算
**目的**: パートタイム労働者の所定労働日数が正しく計算されることを検証
**設定値**:
- 期間開始日: 2023年1月1日
- 期間終了日: 2023年6月30日
- 週所定労働日数: 3日

**検証値と期待結果**:
- 期間日数: 181日
- 所定労働日数: 77日

#### テストケース4-3: 1年間の所定労働日数計算
**目的**: 長期間での所定労働日数計算の正確性を検証
**設定値**:
- 期間開始日: 2023年7月1日
- 期間終了日: 2024年6月30日
- 週所定労働日数: 4日

**検証値と期待結果**:
- 期間日数: 366日（閏年含む）
- 所定労働日数: 209日

### 5. 出勤日数計算メソッド（calculate_attendance）のテスト

#### テストケース5-1: 実出勤のみの出勤日数計算
**目的**: 有給未使用時の出勤日数計算を検証
**設定値**:
- 期間開始日: 2024年1月1日
- 期間終了日: 2024年6月30日
- TimeRecord: 100件の出勤記録
- PaidLeaveRecord（使用）: 0件

**検証値と期待結果**:
- 出勤日数: 100日

#### テストケース5-2: 有給使用を含む出勤日数計算
**目的**: 有給使用日を含めた出勤日数計算を検証
**設定値**:
- 期間開始日: 2024年1月1日
- 期間終了日: 2024年6月30日
- TimeRecord: 95件の出勤記録
- PaidLeaveRecord（使用）: 5件

**検証値と期待結果**:
- 出勤日数: 100日（95+5）

#### テストケース5-3: 境界値（80%ちょうど）の出勤率計算
**目的**: 付与条件境界値での出勤率計算の正確性を検証
**設定値**:
- 週所定労働日数: 5日
- 期間開始日: 2023年1月1日
- 期間終了日: 2023年12月31日
- TimeRecord: 208件の出勤記録

**検証値と期待結果**:
- 出勤率: 0.800（80.0%）

#### テストケース5-4: エラーの処理
**目的**: 所定労働日数が0の場合のエラーハンドリングを検証
**設定値**:
- 期間開始日: 2023年1月2日
- 期間終了日: 2023年1月1日

**検証値と期待結果**:
- ValueError例外が発生すること

### 7. 付与日数決定メソッド（determine_grant_days）のテスト

#### テストケース7-1: 通常労働者の付与日数決定
**目的**: 週5日以上勤務者の付与日数テーブル参照を検証
**設定値**:
- 付与回数: 1, 2, 3, 4, 5, 6, 7, 8回目
- 週所定労働日数: 5日

**検証値と期待結果**:
- 1回目: 10日
- 2回目: 11日
- 3回目: 12日
- 4回目: 14日
- 5回目: 16日
- 6回目: 18日
- 7回目: 20日
- 8回目: 20日（上限）

#### テストケース7-2: 週4日勤務者の付与日数決定
**目的**: 比例付与テーブルの参照を検証（週4日）
**設定値**:
- 付与回数: 1, 2, 3, 4, 5, 6, 7, 8回目
- 週所定労働日数: 4日

**検証値と期待結果**:
- 1回目: 7日
- 2回目: 8日
- 3回目: 9日
- 4回目: 10日
- 5回目: 12日
- 6回目: 13日
- 7回目: 15日
- 8回目: 15日（上限）

#### テストケース7-3: 週3日勤務者の付与日数決定
**目的**: 比例付与テーブルの参照を検証（週3日）
**設定値**:
- 付与回数: 1, 2, 3, 4, 5, 6, 7, 8回目
- 週所定労働日数: 3日

**検証値と期待結果**:
- 1回目: 5日
- 2回目: 6日
- 3回目: 6日
- 4回目: 8日
- 5回目: 9日
- 6回目: 10日
- 7回目: 11日
- 8回目: 11日（上限）

#### テストケース7-4: 週2日勤務者の付与日数決定
**目的**: 比例付与テーブルの参照を検証（週2日）
**設定値**:
- 付与回数: 1, 2, 3, 4, 5, 6, 7, 8回目
- 週所定労働日数: 2日

**検証値と期待結果**:
- 1回目: 3日
- 2回目: 4日
- 3回目: 4日
- 4回目: 5日
- 5回目: 6日
- 6回目: 6日
- 7回目: 7日
- 8回目: 7日（上限）

#### テストケース7-5: 週1日勤務者の付与日数決定
**目的**: 比例付与テーブルの参照を検証（週1日）
**設定値**:
- 付与回数: 1, 2, 3, 4, 5, 6, 7, 8回目
- 週所定労働日数: 1日

**検証値と期待結果**:
- 1回目: 1日
- 2回目: 2日
- 3回目: 2日
- 4回目: 2日
- 5回目: 3日
- 6回目: 3日
- 7回目: 3日
- 8回目: 3日（上限）

### 8. 付与可否判定メソッド（judge_grant_eligibility）のテスト

#### テストケース8-1: 出勤率80%未満での付与判定
**目的**: 付与条件を満たす場合の判定を検証
**設定値**:
- 入社日: 2023年1月1日
- 付与回数: 1回目
- 判定日: 2023年7月1日
- 週所定労働日数: 5日
- 実出勤日数: 90日
- 有給使用日数: 5日

**検証値と期待結果（PaidLeaveJudgmentオブジェクト）**:
- grant_count: 1
- judgment_date: 2023年7月1日
- period_start: 2023年1月1日
- period_end: 2023年6月30日
- required_work_days: 129日
- attendance_days: 95日
- attendance_rate: 0.7364...（計算値）
- grant_days: 0日
- reason: "出勤率が80%未満のため付与なし"

#### テストケース8-2: 出勤率80%以上での付与判定
**目的**: 付与条件を満たさない場合の判定を検証
**設定値**:
- 入社日: 2023年1月1日
- 付与回数: 1回目
- 判定日: 2023年7月1日
- 週所定労働日数: 5日
- 実出勤日数: 100日
- 有給使用日数: 5日

**検証値と期待結果（PaidLeaveJudgmentオブジェクト）**:
- grant_count: 1
- judgment_date: 2023年7月1日
- period_start: 2023年1月1日
- period_end: 2023年6月30日
- required_work_days: 129日
- attendance_days: 105日
- attendance_rate: 0.8139...（計算値）
- grant_days: 10日
- expiry_date: 2025年7月1日
- reason: "付与条件を満たしています"

#### テストケース8-3: 境界値（出勤率ちょうど80%）での付与判定
**目的**: 境界値での判定が正しく行われることを検証
**設定値**:
- 入社日: 2024年1月1日
- 付与回数: 1回目
- 判定日: 2024年7月1日
- 週所定労働日数: 5日
- 実出勤日数: 103日
- 有給使用日数: 1日

**検証値と期待結果（PaidLeaveJudgmentオブジェクト）**:
- grant_count: 1
- judgment_date: 2024年7月1日
- period_start: 2024年1月1日
- period_end: 2024年6月30日
- required_work_days: 130日
- attendance_days: 104日
- attendance_rate: 0.8000...（計算値）
- grant_days: 10日
- expiry_date: 2025年7月1日
- reason: "付与条件を満たしています"

### 9. 再判定要否判断メソッド（should_rejudge）のテスト

#### テストケース9-1: 直近付与日より前の記録修正
**目的**: 再判定が必要な場合の判断を検証
**設定値**:
- 入社日: 2020年1月1日
- 修正された記録の日付: 2020年6月30日
- 修正日: 2020年7月2日
- 直近付与日: 2020年7月1日

**検証値と期待結果**:
- should_rejudge: True（再判定必要）

#### テストケース9-2: 直近付与日以降の記録修正
**目的**: 再判定が不要な場合の判断を検証
**設定値**:
- 入社日: 2020年1月1日
- 修正された記録の日付: 2020年7月1日
- 修正日: 2020年7月2日
- 直近付与日: 2020年7月1日

**検証値と期待結果**:
- should_rejudge: False（再判定不要）

#### テストケース9-3: 付与日当日の記録修正
**目的**: 付与日当日の記録修正では再判定不要であることを検証
**設定値**:
- 入社日: 2020年1月1日
- 修正された記録の日付: 2020年7月1日
- 修正日: 2020年7月1日
- 直近付与日: 2020年7月1日

**検証値と期待結果**:
- should_rejudge: False（再判定不要）

### 10. 影響を受ける付与回特定メソッド（find_affected_grants）のテスト

#### テストケース10-1: 単一の付与回に影響
**目的**: 1回目のみが影響を受ける場合の特定を検証
**設定値**:
- 入社日: 2020年1月1日
- 修正された記録の日付: 2020年6月15日

**検証値と期待結果**:
- 影響を受ける付与回: [1]（1回目のみ）

#### テストケース10-2: 複数の付与回に影響
**目的**: 2回目が影響を受ける場合の特定を検証
**設定値**:
- 入社日: 2020年1月1日
- 修正された記録の日付: 2021年6月15日

**検証値と期待結果**:
- 影響を受ける付与回: [2]（2回目のみ）

### 11. 有効期限計算メソッド（calculate_expiry_date）のテスト

#### テストケース11-1: 通常日付の有効期限計算
**目的**: 2年後の同日が存在する場合の計算を検証
**設定値**:
- 付与日: 2024年7月1日

**検証値と期待結果**:
- 有効期限: 2026年7月1日（2年後の同日）

#### テストケース11-2: 閏年2月29日の有効期限計算
**目的**: 2年後に同日が存在しない場合の月末調整を検証
**設定値**:
- 付与日: 2024年2月29日

**検証値と期待結果**:
- 有効期限: 2026年2月28日（2年後の2月29日が存在しないため月末調整）

#### テストケース11-3: 月末日の有効期限計算
**目的**: 月末日の2年後計算を検証
**設定値**:
- 付与日: 2023年1月31日

**検証値と期待結果**:
- 有効期限: 2025年1月31日（2年後の同日）

## テスト実行時の注意事項

### データベース準備
- 各テストケース実行前に、必要なUserモデル、TimeRecord、PaidLeaveRecordを準備する
- テスト用のダミーユーザーを作成し、入社日と週所定労働日数を設定する

### 日付処理
- テスト実行日に依存しないよう、固定日付を使用する
- タイムゾーンの影響を考慮し、日付のみで判定を行う

### エラーハンドリング
- 異常系のテストでは、適切な例外が発生することを確認する
- エラーメッセージの内容も検証対象とする

### 境界値テスト
- 出勤率80%の境界値
- 月末日の処理
- 閏年の処理
- 週所定労働日数0日〜7日の範囲

### 統合テスト
- 各メソッドが連携して動作することを確認する
- 実際の付与シナリオを想定した一連の処理をテストする

## 補足事項

### テストデータの管理
- テストデータはフィクスチャとして管理し、再利用可能にする
- 各テストケースは独立して実行可能にする

### パフォーマンステスト
- 大量のTimeRecordがある場合の処理速度を検証する
- 複数年にまたがる期間での計算パフォーマンスを確認する

### 回帰テスト
- 仕様変更時は、既存のテストケースが全て通ることを確認する
- 新規機能追加時は、対応するテストケースを追加する