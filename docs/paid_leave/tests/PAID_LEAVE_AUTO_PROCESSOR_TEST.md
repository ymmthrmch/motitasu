# PaidLeaveAutoProcessorクラステスト仕様書

## 概要
本仕様書は、PaidLeaveAutoProcessorクラスの各メソッドに対するテストケースを定義する。
各テストケースでは、設定値と期待される検証結果を明確に定義し、有給休暇の自動処理とシグナル連携が正確に行われることを検証する。

## テストケース一覧

### 1. 日次付与処理メソッド（process_daily_grants_and_expirations）のテスト

#### テストケース1-1: 付与対象ユーザーが存在する場合の日次処理
**目的**: 指定日が付与日に該当するユーザーの正常な付与処理を検証
**設定値**:
- target_date: 2023年7月1日
- ユーザー1: 
  - 入社日: 2023年1月1日
  - 週所定労働日数: 5日
  - paid_leave_grant_schedule: [2023年7月1日, 2024年7月1日, ...]
- TimeRecord: 十分な出勤記録（80%以上の出勤率）

**検証値と期待結果**:
- 戻り値: [PaidLeaveJudgmentオブジェクト（付与成功）]
  - user: ユーザー1のオブジェクト
  - grant_count: 1
  - is_eligible: True
  - grant_days: 10
  - judgment_date: 2023年7月1日
- 作成されるPaidLeaveRecord:
  - record_type: 'grant'
  - grant_date: 2023年7月1日
  - days: 10
- user.current_paid_leave: 10日（更新確認）

#### テストケース1-2: 付与対象ユーザーが存在しない場合の日次処理
**目的**: 指定日が付与日に該当しないユーザーのみの場合の処理を検証
**設定値**:
- target_date: 2023年7月1日
- ユーザー1:
  - 入社日: 2023年2月1日
  - paid_leave_grant_schedule: [2023年8月1日, 2024年8月1日, ...]（対象外）

**検証値と期待結果**:
- 戻り値: []（空のリスト）
- PaidLeaveRecordは作成されない
- 処理対象ユーザー数: 0

#### テストケース1-3: 複数ユーザーの同時処理
**目的**: 複数のユーザーが同時に付与対象となる場合の処理を検証
**設定値**:
- target_date: 2023年7月1日
- ユーザー1: 入社日2023年1月1日（1回目付与）
- ユーザー2: 入社日2022年1月1日（2回目付与）
- ユーザー3: 入社日2022年8月1日（対象外）
- 各ユーザー: 十分な出勤記録

**検証値と期待結果**:
- 戻り値: [2件のPaidLeaveJudgmentオブジェクト]
- ユーザー1: 10日付与
- ユーザー2: 11日付与
- ユーザー3: 処理対象外

#### テストケース1-4: 付与条件を満たすユーザー・満たさないユーザー混在時の処理
**目的**: 出勤率条件を満たすユーザーと満たさないユーザーが混在する場合の処理を検証
**設定値**:
- target_date: 2023年7月1日
- ユーザー1: 入社日2023年1月1日、出勤率85%（条件満たす）
- ユーザー2: 入社日2023年1月1日、出勤率75%（条件満たさない）

**検証値と期待結果**:
- 戻り値: [2件のPaidLeaveJudgmentオブジェクト]
- ユーザー1: is_eligible=True, grant_days=10
- ユーザー2: is_eligible=False, grant_days=0

#### テストケース1-5: 時効処理も同時実行されることの確認
**目的**: 日次処理で付与処理と時効処理が同時に実行されることを検証
**設定値**:
- target_date: 2023年7月1日
- ユーザー1: 新規付与対象
- ユーザー2: 時効対象の有給あり（expiry_date=2023年7月1日）

**検証値と期待結果**:
- 戻り値: [付与判定結果のリスト]
- ユーザー1: 新規付与記録作成
- ユーザー2: 時効記録作成（PaidLeaveGrantProcessorを通じて）

#### テストケース1-6: 大量ユーザーでの処理効率確認
**目的**: 多数のユーザーが存在する場合の処理効率を検証
**設定値**:
- target_date: 2023年7月1日
- ユーザー: 1000名（うち550名が判定対象）

**検証値と期待結果**:
- 戻り値: [550件のPaidLeaveJudgment]
- 処理時間が許容範囲内であること
- メモリ使用量が適切であること

### 2. TimeRecord変更処理メソッド（process_time_record_change）のテスト

#### テストケース2-1: 再判定が必要な場合のTimeRecord変更処理
**目的**: 直近付与日より前の記録変更により再判定が実行されることを検証
**設定値**:
- 基準日（本日）: 2023年7月2日
- ユーザー: 
  - 入社日: 2023年1月1日
  - paid_leave_grant_schedule: [2023年7月1日, 2024年7月1日, ...]
- record_date: 2023年6月30日（直近付与日より前）
- change_type: 'create' 

**検証値と期待結果**:
- should_rejudge: True（再判定実行）
- 戻り値: [PaidLeaveJudgmentオブジェクト（再判定結果）]
- 影響を受ける付与回の再判定が実行される

#### テストケース2-2: 再判定が不要な場合のTimeRecord変更処理
**目的**: 直近付与日以降の記録変更では再判定が実行されないことを検証
**設定値**:
- 基準日（本日）: 2023年7月2日
- ユーザー
  - 入社日: 2023年1月1日
- record_date: 2023年7月2日
- change_type: 'create'

**検証値と期待結果**:
- should_rejudge: False
- 戻り値: []（空のリスト）
- 再判定処理は実行されない

#### テストケース2-3: TimeRecord作成時の処理
**目的**: TimeRecord新規作成時の再判定処理を検証
**設定値**:
- ユーザー: 入社日2023年1月1日、直近付与日2023年7月1日
- record_date: 2023年6月30日
- change_type: 'create'
- 新規TimeRecord: timestamp=2023年6月30日 09:00

**検証値と期待結果**:
- 再判定実行確認
- 出勤日数の増加により付与条件への影響確認

#### テストケース2-4: TimeRecord削除時の処理
**目的**: TimeRecord削除時の再判定処理を検証
**設定値**:
- ユーザー: 入社日2023年1月1日、直近付与日2023年7月1日
- record_date: 2023年6月30日
- change_type: 'delete'
- 削除されるTimeRecord: timestamp=2023年6月30日 09:00

**検証値と期待結果**:
- 再判定実行確認
- 出勤日数の減少により付与条件への影響確認

#### テストケース2-5: 付与日当日の記録変更
**目的**: 付与日当日の記録変更では再判定が実行されないことを検証
**設定値**:
- ユーザー: 直近付与日2023年7月1日
- record_date: 2023年7月1日（付与日当日）
- change_type: 'create'

**検証値と期待結果**:
- should_rejudge: False
- 戻り値: []（空のリスト）

#### テストケース2-7: まだ付与がないユーザーの記録変更
**目的**: まだ一度も付与されていないユーザーの記録変更処理を検証
**設定値**:
- ユーザー: 入社日2023年5月1日（初回付与前）
- record_date: 2023年6月1日
- change_type: 'create'

**検証値と期待結果**:
- 戻り値: []（再判定対象なし）
- 処理は正常終了

### 3. PaidLeaveRecord変更処理メソッド（process_paid_leave_record_change）のテスト

#### テストケース3-1: 有給使用記録作成時の残日数更新
**目的**: 有給使用記録作成時に残日数が正しく更新されることを検証
**設定値**:
- ユーザー: current_paid_leave=10
- record: PaidLeaveRecord（record_type='use', days=3）
- change_type: 'create'

**検証値と期待結果**:
- user.current_paid_leave: 7日（10-3）
- 戻り値: None

#### テストケース3-2: 有給付与記録作成時の残日数更新
**目的**: 有給付与記録作成時に残日数が正しく更新されることを検証
**設定値**:
- ユーザー: current_paid_leave=5
- record: PaidLeaveRecord（record_type='grant', days=10）
- change_type: 'create'

**検証値と期待結果**:
- user.current_paid_leave: 15日（5+10）
- 戻り値: None

#### テストケース3-3: 有給取消記録作成時の残日数更新
**目的**: 有給取消記録作成時に残日数が正しく更新されることを検証
**設定値**:
- ユーザー: current_paid_leave=10
- record: PaidLeaveRecord（record_type='cancel', days=5）
- change_type: 'create'

**検証値と期待結果**:
- user.current_paid_leave: 5日（10-5）
- 戻り値: None

#### テストケース3-4: 時効記録作成時の残日数更新
**目的**: 時効記録作成時に残日数が正しく更新されることを検証
**設定値**:
- ユーザー: current_paid_leave=8
- record: PaidLeaveRecord（record_type='expire', days=3）
- change_type: 'create'

**検証値と期待結果**:
- user.current_paid_leave: 5日（8-3）
- 戻り値: None

#### テストケース3-5: PaidLeaveRecord更新時の残日数更新
**目的**: 既存のPaidLeaveRecord更新時の残日数更新を検証
**設定値**:
- ユーザー: current_paid_leave=7
- record: PaidLeaveRecord（record_type='use', days=5）← 以前は3日
- change_type: 'update'

**検証値と期待結果**:
- user.current_paid_leave: 再計算された正しい残日数
- 戻り値: None

#### テストケース3-6: PaidLeaveRecord削除時の残日数更新
**目的**: PaidLeaveRecord削除時の残日数更新を検証
**設定値**:
- ユーザー: current_paid_leave=5
- record: PaidLeaveRecord（record_type='use', days=3）削除
- change_type: 'delete'

**検証値と期待結果**:
- user.current_paid_leave: 8日（5+3）
- 戻り値: None

#### テストケース3-7: 複数のPaidLeaveRecord変更の連続処理
**目的**: 複数の記録変更が連続して発生した場合の処理を検証
**設定値**:
- ユーザー: current_paid_leave=10
- 処理1: 使用記録作成（days=2）
- 処理2: 付与記録作成（days=5）
- 処理3: 使用記録削除（days=1）

**検証値と期待結果**:
- 最終的なuser.current_paid_leave: 14日（10-2+5+1）
- 各処理で正しく更新されること

### 4. エラー処理・例外処理のテスト

#### テストケース4-1: 存在しないユーザーに対する処理
**目的**: 削除されたユーザーに対する処理でエラーが発生しないことを検証
**設定値**:
- 存在しないユーザーID
- record_date: 2023年6月30日
- change_type: 'create'

**検証値と期待結果**:
- 適切なエラーハンドリング
- 処理の中断なし

#### テストケース4-2: データベース接続エラー時の処理
**目的**: データベース接続エラー時の適切なエラー処理を検証
**設定値**:
- データベース接続を一時的に無効化
- 正常な処理パラメータ

**検証値と期待結果**:
- 適切な例外発生
- ログ出力確認

#### テストケース4-3: 無効な日付での処理
**目的**: 無効な日付が指定された場合のエラー処理を検証
**設定値**:
- target_date: None（無効な日付）
- record_date: "invalid_date"

**検証値と期待結果**:
- ValueError等の適切な例外発生
- 処理の安全な停止

### 5. パフォーマンス・統合テスト

#### テストケース5-1: 大量データでのパフォーマンステスト
**目的**: 大量のTimeRecord、PaidLeaveRecordがある場合の処理性能を検証
**設定値**:
- ユーザー数: 1000名
- TimeRecord: 各ユーザー年間300件
- PaidLeaveRecord: 各ユーザー年間20件

**検証値と期待結果**:
- 処理時間が許容範囲内
- メモリ使用量が適切
- データベース接続数が適切

#### テストケース5-2: 他クラスとの統合動作テスト
**目的**: PaidLeaveCalculator、PaidLeaveBalanceManager、PaidLeaveGrantProcessorとの連携動作を検証
**設定値**:
- 複合的な処理シナリオ
- 各クラスのメソッドが正しく呼び出されること

**検証値と期待結果**:
- 全クラスが正常に連携動作
- データの一貫性維持
- 期待される結果の出力

## テスト実行時の注意事項

### データベース準備
- 各テストケース実行前に、必要なUserモデル、TimeRecord、PaidLeaveRecordを準備する
- paid_leave_grant_scheduleフィールドを適切に設定する
- テストデータの独立性を保つ

### 日付処理
- テスト実行日に依存しないよう、固定日付を使用する
- タイムゾーンの影響を考慮し、日付のみで判定を行う

### モック・スタブの利用
- 外部依存関係（他のサービスクラス）は適切にモック化する
- データベーストランザクションのテスト環境を整備する

### シグナル処理のテスト
- テスト時にシグナルが正しく動作することを確認
- シグナル無効化が必要な場合のフラグ設定

### エラーハンドリング
- 各種例外が適切に処理されることを確認
- ログ出力の内容と形式を検証

### 境界値テスト
- 日付の境界値（月末、年末等）
- 大きな数値での処理
- 空のデータセットでの処理

### 並行処理テスト
- 複数のプロセスが同時に実行された場合の動作
- データベースロックの適切な処理

## 補足事項

### テストデータの管理
- フィクスチャを活用してテストデータを管理
- テストケース間の独立性を保つ

### デバッグとログ
- 処理過程の詳細なログ出力確認
- エラー発生時のスタックトレース検証

### 回帰テスト
- 仕様変更時の既存テスト確認
- 新機能追加時のテストケース追加

### メンテナンス性
- テストコードの可読性と保守性を重視
- 共通処理の関数化・モジュール化